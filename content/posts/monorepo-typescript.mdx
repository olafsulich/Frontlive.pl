---
title: 'Monorepo z Lerna, Yarn Workspaces i TypeScript'
category: 'Architektura'
publishedAt: '11-10-2021'
isPublished: true
popular: false
image: '/images/monorepo-typescript/thumbnail.png'
excerpt: 'Jak zarzdza projektem, w kt贸rym mamy kilka repozytori贸w z kodem? Utrzymywanie zewntrzynch zale偶noci, sprawny development, bezbolesny release, to tylko niekt贸re z wyzwa, z kt贸rymi musimy si mierzy przy wikszych codebasach. Jak to ogarn?'
---

Jak zarzdza projektem, w kt贸rym mamy kilka _paczek\*_ z kodem? Utrzymywanie zewntrznych zale偶noci, sprawny development, bezbolesny release, to tylko niekt贸re z wyzwa, z kt贸rymi musimy si mierzy przy wikszych codebasach. Jak to ogarn?

_\*_ paczka, inaczej projekt, wydzielony kawaek kodu

## Rodzaje repozytori贸w

Zanim zaczniemy, rozr贸偶nijmy trzy podstawowe rodzaje repozytori贸w:

1. Multirepo - ka偶da nasza _paczka_, jest w osobnym repozytorium - klasyczny podzia.

2. **Monorepo** - gwiazda dzisiejszego wieczoru, w tym podziale posiadamy wiele **wyizolowanych** projekt贸w, ale sone zebrane w ramach jednego repo. Mog (ale nie musz) by od siebie zale偶ne.

3. Monolit - tutaj w przeciwiestwie do poprzednich rodzaj贸w, cay nasz codebase jest zebrany w jednej _paczce_, w jednym repozytorium.

<Image src="/images/monorepo-typescript/rodzaje-repo.png" alt="Rodzaje repozytori贸w" />

## Monorepo

Zatrzymajmy sina chwilprzy samym koncepcie monorepo, wiemy ju偶, 偶e w takim systemie przechowujemy wszystkie nasze _paczki_ w jednym repozytorium, tylko po co?

Za贸偶my, 偶e tworzymy nowy projekty, backend i frontend bd napisane w tej samej technologii - TypeScripcie. Takie rozwizanie jest super, bo po jakimczasie bdziemy mogli reu偶ywa kawaki kodu w obu aplikacjach, oh wait, tylko jak to zrobi? To nie koniec problem贸w, podobne konfiguracje toolingu, powtarzajce sizewntrzne pakiety, kt贸re trzeba utrzymywa, wersjonowanie i publikowanie, to tylko niekt贸re rzeczy, z kt贸rymi musielibymy simierzy na co dzie...

Do plus贸w Monorepo mo偶emy zaliczy:

- Reu偶ywanie kodu
- atwiejsze zarzdzanie pakietami
- Sprawniejsze procesy (lint, build, test, release)
- Refactoring na du偶 skal
- Jedno miejsce do zgaszania issues (open source)

Oczywicie takie rozwizanie nie jest zo偶one z samych zalet, do jakiego wad mo偶na zaliczy:

- Brak mo偶liwoci ograniczenia dostpu do pojedynczej paczki
- Konieczno pobrania caego repo, nawet jeli pracujemy tylko nad jednpaczk
- Problemy z systemem kontroli wersji przy bardzooo du偶ej skali (typu Google/Facebook)
- Du偶szy build

### Kto korzysta z Monorepo?

Koncept pojedynczych repozytori贸w nie jest znany od wczoraj, korzystaj z niego tacy giganci jak Google, czy Facebook, ale r贸wnie偶 "mniejsi" gracze/projekty zwizane z technologiami, np. Next.js, Vue i Babel.

<Image
  src="/images/monorepo-typescript/lerna-firmy.png"
  alt="Firmy i projekty, kt贸re korzystaj z Lerny"
/>

## Lerna & Yarn Workspaces

Pierwszym ze skadnik贸w naszego projektu bdzie [Lerna](https://github.com/lerna/lerna). To narzdzie jest baz pod nasze monorepo, dostarcza nam tooling potrzebny do wykonywania skrypt贸w pomidzy paczkami, wersjonowanie i publikowanie paczek. Lernmo偶emy wykorzysta r贸wnie偶 jako managera zale偶noci, ale w zwizku z tym, 偶e na pokadzie mamy jeszcze Yarn Workspaces, podzielmy trochodpowiedzialno.

Workspaces posu偶 nam za inteligenty manager zewntrznych pakiet贸w, dziki niemu _poczymy_ ze sob zale偶noci, bdziemy posiadali tylko jeden `yarn.lock`, co uatwi nam p贸藕niejsze utrzymanie pakiet贸w. Yarn Workspaces dostarczaj nam r贸wnie偶 mechanizm, w kt贸rym jeden z naszych lokalnych projekt贸w bdzie mog byzale偶ny od drugiego.

Co ciekawe, te dwie technologie mo偶emy wykorzysta niezale偶nie od siebie, jeli chcesz si trochbardziej wgbi w r贸偶nice, to polecam wietny [artyku autorstwa Sebastiana Webera](https://doppelmutzi.github.io/monorepo-lerna-yarn-workspaces/).

<Image
  src="/images/monorepo-typescript/lerna-yarn-powiazanie.png"
  alt="Diagram powizania pomidzy Lern, Yarn workspaces i Yarnem"
/>

## Monorepo w praktyce

Zanim przejdziemy do waciwej konfiguracji, z zao偶enia nasz projekt bdzie bardzo prosty, bdziemy posiadali trzy niezale偶ne paczki - backend, frontend i types. Dwie pierwsze bdwsp贸dzieliy typy z TypeScripta:

<Image
  src="/images/monorepo-typescript/repo-typescript.png"
  alt="Przepyw danych pomidzy typami z TypeScript, a repozytoriami"
/>

### Konfiguracja

Jeli ju偶 zainstalowalimy Lern, to przechodzimy do jej konfiguracji, to czego potrzebujemy to plik `lerna.json`, a w nim:

```json
{
  "npmClient": "yarn",
  "useWorkspaces": true,
  "packages": ["packages/*"],
  "version": "1.0.0"
}
```

W tym miejscu okrelamy czy bdziemy korzystali z NPM, czy z Yarna, ustawiamy r贸wnie偶 miejsce skadowania _paczek_ i wersj projektu.

W `package.json`, poza standardowymi rzeczami, wskazujemy `workspaces`, kt贸re potrzebne s Yarnowi:

```json
{
  "name": "root",
  "version": "1.0.0",
  "license": "MIT",
  "private": true,
  "workspaces": {
    "packages": ["packages/*"]
  }
}
```

## Instalacja zale偶noci

Tak jak wczeniej wspomniaem, zarzdzaniem zewntrznymi zale偶nociami bd si zajmoway Yarn Workspaces. 呕eby doda jaki pakiet, wystarczy stosowa si takiego patternu:

```bash
yarn workspace <nazwa_lokalnej_paczki> add <nazwa_zewntrznej_zale偶noci>
```

W kontekcie naszego projektu bdzie to wygldao w ten spos贸b:

```bash
yarn workspace frontend parcel-bundler --save-dev
```

Jeli chcemy doda pakiet, kt贸ry bdzie wystpowa we wszystkich naszych _paczkach_, wystarczy, 偶e zrobimy:

```bash
yarn add <nazwa_zewntrznej_zale偶noci> -W
```

<Newsletter />

## Powizanie lokalnych paczek

Esencja dzisiejszego artykuu, czyli jak reu偶ywa typy pomidzy frontendem, a backendem?

Za贸偶my, 偶e w paczce `types` posiadamy typ u偶ytkownika:

```ts
export type User = {
  id: string;
  name: string;
  points: number;
};
```

Aby skorzysta z niego w paczce `backend`, musimy wykona tak komend:

```bash
yarn workspace backend add types@1.0.0
```

<Image
  src="/images/monorepo-typescript/lokalne-powiazania-paczki.png"
  alt="Diagram lokalne powizania midzy TypeScriptowymi typami, a paczkami frontend i backend"
/>

> Wa偶ne jest, aby uwa偶a tutaj z wersjami - lepiej zadeklarowa konkretn wersj, w moim przypadku yarn "藕le" domyla si, jak naprawd ma doda

Jeli wszystko poszo zgodnie z planem, powinnimy zobaczy now zale偶now `package.json` w paczce `backend`:

```json
"dependencies": {
   "types": "^1.0.0"
}
```

Korzystamy z niej dokadnie tak samo, jak z ka偶dej innej zale偶noci:

```ts
import express from 'express';
import type { User } from 'types';
import { v4 as uuidv4 } from 'uuid';

const app = express();

const user: User = {
  id: uuidv4(),
  name: 'User',
  points: 10012,
};

app.get('/', (req, res) => res.send('Monorepo Backend'));
app.listen(8000);
```

## Praca z Lern

Uff, udao nam si wykorzysta Yarn Workspaces, czas na Lern, po co tak waciwie nam ona w projekcie? 

### Procesy

Jak ju偶 wspomniaem na samym pocztku, Lerna **wietnie** usprawnia nam pracz r贸偶nymi procesami. Czsto spotykane procesy w aplikacjach TypeScriptowych:

- lint
- test
- format
- build

My zajmiemy si tym pierwszym, ale cay _przepis_ bdzie r贸wnie偶 dziaa na inne procesy. Do naszego procesu `lint` wykorzystamy dobrze znanego wszystkim ESlinta.

Instalacja:

```bash
yarn add eslint @typescript-eslint/eslint-plugin @typescript-eslint/parser prettier eslint-config-prettier eslint-plugin-prettier -W
```

Konfiguracja:

```json
{
  "root": true,
  "parser": "@typescript-eslint/parser",
  "parserOptions": {
    "sourceType": "module",
    "ecmaVersion": 2021
  },

  "plugins": ["@typescript-eslint"],
  "extends": ["prettier", "plugin:prettier/recommended", "plugin:@typescript-eslint/recommended"]
}
```

Chcemy wykonywa ten proces w paczkach `frontend` i `backend`, dodajemy w obu miejscach skrypt w `package.json`:

```json
"scripts": {
    "lint": "eslint . --ext ts"
    }
```

Dla uproszczenia, w naszym projekcie posiadamy tylko jeden plik konfiguracyjny ESlinta oraz takie same skrypty, ale nic nie stoi nam na przeszkodzie, 偶eby zrobi je **zupenie inne** w ka偶dej z naszych paczek 

W katalogu g贸wnym projektu, do `package.json` dodajemy odpowiedni skrypt:

```json
"scripts": {
    "lint": "lerna run lint --stream"
    }
```

A nastpnie wywoujemy:

```bash
lerna run lint
```

Dziki temu we wszystkich naszych paczkach zostanie wywoany `eslint . --ext ts`. Ten i podobne procesy wraz z Lern, super sicz z narzdziami typu [Lint Staged](https://github.com/okonet/lint-staged) i [Husky](https://github.com/typicode/husky), zdecydowanie warto spr贸bowa!

<Image
  src="/images/monorepo-typescript/procesy-lint.png"
  alt="Diagram procesu lintowania wraz z wykorzystaniem Lerny"
/>

## Wersjonowanie

Wykorzystanie Lerny do wersjonowania paczek to atwizna wystarczy jedna komenda:

```bash
lerna version [major | minor | patch | premajor | preminor | prepatch | prerelease]
```

Co si dzieje po wykonaniu tej komendy? Lerna za kulisami sprawdzi jakie zmiany zostay zaaplikowane w danych paczkach, otaguje now wersj i wypushuje na zdalne rezpotorium Gita.

<Image
  src="/images/monorepo-typescript/wersjonowanie.png"
  alt="Wersjonowanie: Patch (1.0.1), Minor (1.2.0), Major (2.0.0)"
/>

Warto jeszcze wspomnie o fladze `--conventional-commits`, kt贸ra korzysta z [Conventional Commits](https://conventionalcommits.org/) i automatycznie okreli wersje oraz wygeneruje changelog:

```bash
lerna version --conventional-commits
```

## Publikowanie do rejestru NPM

Tutaj sprawa wyglda bardzo podobnie jak poprzednio. Wystarczy jedna komenda:

```bash
lerna publish
```

Po jej wykonaniu wszystkie paczki, kt贸re zostay zmienione od poprzedniej wersji, zostan opublikowane.

> Paczki musz mie ustawione `"private": false` w `package.json`, inaczej Lerna nie rozpocznie procesu publikacji

## Podsumowanie

To by byo na tyle, jeli chodzi o kr贸tkie wprowadzenie do tematu Monorepo 

Zar贸wno Lerna, jak i Yark Workspaces oferuj znacznie wicej, a komfort pracy z takim poczeniem stoi na wysokim poziomie - zachcam do dalszego zgbiania 

Do usyszenia!

### 殴r贸da

- [Why is Babel a monorepo?](https://github.com/babel/babel/blob/master/doc/design/monorepo.md)
- [Monorepos in the Wild](https://medium.com/@maoberlehner/monorepos-in-the-wild-33c6eb246cb9)
