---
title: 'Optymalizacja zewntrznych skrypt贸w przez Web Workery, Partytown i Next.js'
category: 'Performance'
publishedAt: '11-04-2022'
isPublished: true
popular: false
image: '/images/partytown/thumbnail.png'
excerpt: 'adujesz skrypty Google, Facebooka i dymka wiadomoci, a wynik Lighthouse wieci cay na czerwono? Web Workery do pomocy!'
---

Performance w 2022 roku to jedna z najbardziej kluczowych rzeczy podczas budowania stron i aplikacji webowych. Poza najwa偶niejszymi odczuciami u偶ytkownika, wiemy, 偶e Google bierze pod uwagmetryki wydajnoci podczas pozycjonowania. Czasem nie wa偶ne jak bardzo bymy sistarali, pomimo optymalizacji obrazk贸w i font贸w, wynik Lighthouse dla naszego projektu mo偶e wieci sicay na czerwono... Zewntrzne skrypty mog by powodem!

## Problem

adujesz Google Analytics, Tag Manager, skrypty Facebooka, dymka wiadomoci... Uff, sporo tego, prawda? A teraz wyobra藕 sobie, 偶e to wszystko lduje w [g贸wnym wtku](https://developer.mozilla.org/en-US/docs/Glossary/Main_thread) razem z caym potrzebnym JavaScriptem do prawidowego funkcjonowania Twojej aplikacji. Nie brzmi to najlepiej. Przy dobrym poczeniu sieciowym ten problem mo偶e nie mie a偶 takiego znaczenia, ale jeli spojrzymy na to, jak dziaajstrony na urzdzeniach mobilnych, to zaczynamy dostrzega pewne komplikacje.

## Optymalizacja skrypt贸w w Next.js

Pierwszym krokiem by usprawni proces pobierania skrypt贸w, byoby dodanie atrybutk贸w `async` / `defer` do tagu `<script>`. Dziki temu nie blokujemy parsowania dokumentu HTML. Przydaoby sir贸wnie偶 dodanie [preconnect i dns prefetch](https://web.dev/preconnect-and-dns-prefetch/), dziki nim szybciej zaadresujemy ch pobrania czegoz zewntrznej domeny. To brzmi jak... kawaek niepotrzebnego boilerplate'u. Na szczcie tw贸rcy Next.js zadbali o Developer Experience i wprowadzili ich autorski komponent `<Script>`:

```tsx
<Script src="..." strategy="beforeInteractive" />
<Script src="..." strategy="afterInteractive" />
<Script src="..." strategy="lazyOnload" />
```

1. `beforeInteractive` - przeciwiestwo tego, z czym chcemy dzi walczy. Krytyczne skrypty, kt贸re chcemy odpala jeszcze przed tym, jak strona bdzie interaktywna
2. `afterInteractive` - aduje skrypty tu偶 po osigniciu penej interaktywnoci strony. Sprawdzi sinp. dla Google Analytics / Tag Manager
3. `lazyOnload` - ostatnie skrypty w kolejce. Jak ju偶 siwszystko zaadowao, to lecimy wanie z nimi. Idealne dla rzeczy, kt贸re mog by adowane "w tle", np. dymek wiadomoci

To wszystko brzmi naprawdwietnie i faktycznie Next robi za nas zajebistrobotw optymalizacji skrypt贸w. Wady? Nadal obci偶amy g贸wny wtek.

## Web Workery i Partytown

Rozwizanie naszego problemu? Web Workery. Dziaaj one z dala od g贸wnego wtku, nie ingerujc w skrypty potrzebne do interaktywnoci strony...Hola hola, Web Workery? Przecie偶 [system komunikacji](https://developer.mozilla.org/en-US/docs/Web/API/Worker/postMessage) pomidzy Web Workerem, a g贸wnym wtkiem jest asynchroniczny, przez co Web Worker nie ma bezporedniego dostpu do API przegldarki. Jest to du偶ym problemem dla zewntrznych skrypt贸w, bowiem dziaaj one czsto w oparciu o DOM.

[Partytown](https://www.npmjs.com/package/@builder.io/partytown) to leciutka biblioteka, kt贸ra rozwizuje ten problem.

<Image
  src="/images/partytown/thread.png"
  alt="Przebieg 'normalnych' skrypt贸w przez g贸wny wtek, kontra wykorzystanie Web Worker贸w do przepywu zewntrznych skrypt贸w"
/>

Pozwala ona na synchronicznkomunikacjWeb Workera z g贸wnym wtkiem, jest swego rodzaju proxy. Poza dostpem do DOM, mamymo偶liwo zarzdzania dostpem do niekt贸rych API, np. mo偶emy zablokowa dostp do `document.cookie`, czy uniemo偶liwi zapisywanie skryptowi do `localStorage`.

## Partytown i Next.js w praktyce

Partytown to biblioteka typu _framework agnostic_, dziaa ze zwykym HTML, React, Nuxt, Remix oraz od niedawna z dedykowanym komponentem `<Script>` w Next. Zacznijmy od instalacji:

```bash
 npm install @builder.io/partytown
```

Next.js "natywnie" wspiera Partytown dopiero w wersji eksperymentalnej, 偶eby z niej skorzysta musimy uzupenikonfiguracj:

```js:next.config.js
module.exports = {
  experimental: {
    nextScriptWorkers: true,
  },
}
```

Zostao nam tylko odpalenie projektu i wykorzystanie `strategy="worker"` w komponencie `<Script>`, od teraz nasz g贸wny wtek bdzie wolny od skrypt贸w third-party.

```tsx
<Script src="..." strategy="worker" />
```

## Debugowanie

Chocia偶Partytown nie wymaga 偶adnej dodatkowej konfiguracji, to przydatna mo偶e okaza opcja `debug`. Aby jodblokowa, musimy doda skrypt z atrybutem `data-partytown-config` do [Next Document](https://nextjs.org/docs/advanced-features/custom-document):

```tsx:pages/_document.tsx
import { Html, Head, Main, NextScript } from 'next/document';

export default function Document() {
  return (
    <Html>
      <Head>
        <script
          data-partytown-config
          dangerouslySetInnerHTML={{
            __html: `
              partytown = {
                lib: "/_next/static/~partytown/",
                debug: true
              };
            `,
          }}
        />
      </Head>
      <body>
        <Main />
        <NextScript />
      </body>
    </Html>
  );
}
```

Jeli co p贸jdzie nie po naszej myli, to dziki `debug: true` zobaczymy to zapewne w logach:

<Image src="/images/partytown/debug.png" alt="Logowanie dla trybu 'debug: true' w Partytown" />

## Wady Partytown

To wszystko wydaje si byzbyt pikne, prawda? Jak wszystko w programowaniu, Partytown posiada wiele wad i ogranicze. Dla mnie najwikszym blockerem jest to, 偶e biblioteka jest bardzo wie偶ym i niedojrzaym rozwizaniem. Jakie trade-offy sikryj po stronie technicznej?

- biblioteka nie jest przyjazna dla skrypt贸w operujcych na DOM i wprowadzajcych interaktywno z UI. Wszystkie operacje na DOM w Workerze scelowo op贸藕niane, przez co bd wolniejsze od tradycyjnego operowania na g贸wnym wtku.
- konieczno wprowadzanie [proxy](https://partytown.builder.io/proxying-requests) 偶dania dla zewntrznych skrypt贸w, kt贸re nie korzystajz nag贸wka `Access-Control-Allow-Origin: *`.
- brak wsparcia dla [event.preventDefault()](https://developer.mozilla.org/en-US/docs/Web/API/Event/preventDefault).
- ograniczenia w obsudze ciasteczek i localStorage dla cross-origin iframe

## Partytown vs Next Script

Pytanie, kt贸re narodzio siw mojej gowie, kiedy poznawaem Partytown, to:

> "Kiedy tak waciwie korzystaze zwykych skrypt贸w, a kiedy je delegowado Web Workera?".

Pomijajc ju偶niedojrzaotego rozwizania, Partytown sprawdzi siwietnie dla skrypt贸w, kt贸re mogdziaanieco "w tle" - Google Analytics, czy Facebook Pixel to dobre przykady. Wszystkie inne skrypty, kt贸re wymagaj interakcji z DOM, warto wzi pod lup. Jeli tych operacji jest troch, to raczej bez zastanowienia skaniabym siku normalnym skryptom w Next - bdzie po prostu szybciej 

## Podsumowanie

Partytown pomimo wszystkich swoich wad, jest naprawd bardzo ciekawym narzdziem do optymalizacji zewntrznych skrypt贸w - w kocu dajemy odetchn naszemu g贸wnemu wtkowi!

Bardzo siciesz, 偶e tw贸rcy bibliotek coraz wikszy nacisk kadwanie na performance, to realnie przekada sina odczucia u偶ytkownika :)

A Ty co sdzisz o Partytown?

## 殴r贸da

- [Dokumentacja Partytown](https://partytown.builder.io/)
- [Dokumentacja Next.js](https://nextjs.org/docs/basic-features/script)
- [Web.dev- Loading Third-Party JavaScript](https://web.dev/optimizing-content-efficiency-loading-third-party-javascript)
